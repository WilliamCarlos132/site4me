# 网站资讯页面时间戳格式问题修复说明

## 问题描述
网站资讯页面存在以下问题：
1. 访问人数显示会突然变成很久之前的45人
2. 最近访问记录的时间戳格式不统一，有时显示 "2026-2-28 12:57:48 AM"，有时显示 "2026/2/28 00:56:29"
3. 数据无法同步和更新

## 根本原因
使用了 JavaScript 的 `toLocaleString()` 方法来格式化时间戳，该方法会根据浏览器的本地设置生成不同的时间格式，导致：
- 时间格式不一致
- Firebase 数据同步时格式变动引起的数据混乱
- 旧数据使用了不同的格式，导致显示错误

## 修复方案

### 1. 后端修复 (server/server.js)

#### 添加统一的时间格式化函数
```javascript
function formatTimestamp(timestamp) {
  const date = new Date(timestamp);
  
  // 格式：YYYY/M/D HH:MM:SS（与预期格式一致）
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  const day = date.getDate();
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  const seconds = String(date.getSeconds()).padStart(2, '0');
  
  return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
}
```

#### 添加数据规范化函数
```javascript
function normalizeRecentVisitsTimestamp(visits) {
  // 确保所有旧数据的时间戳格式都转换为统一的格式
  // 检测到非标准格式时自动转换
}
```

#### 修改关键位置
1. **第416行** - 创建访问记录时使用 `formatTimestamp(timestamp)` 替代 `toLocaleString()`
2. **GET /api/stats/:key** - 返回数据时对 recentVisits 进行规范化
3. **GET /api/stats** - 返回所有数据时对 recentVisits 进行规范化
4. **POST /api/analytics/pageview** - 加载 recentVisits 时进行规范化

### 2. 前端修复 (src/views/NewsView.vue)

#### 添加前端规范化函数
在 methods 中添加 `normalizeRecentVisitsTimestamp` 方法，用于规范化从 Firebase 或 API 返回的数据。

#### 修改数据加载位置
1. **initFirebaseListeners** - Firebase 实时监听回调中进行规范化
2. **loadRecentVisits** - 从 API 和 Firebase 加载数据时进行规范化
3. **BroadcastChannel** - 跨标签页通信时进行规范化

## 时间戳格式标准
**统一格式：YYYY/M/D HH:MM:SS**
- 示例：2026/2/28 00:56:29
- 不再使用浏览器本地化格式

## 验证步骤
1. 清空浏览器缓存（LocalStorage 和 IndexedDB）
2. 刷新网站资讯页面
3. 检查最近访问记录的时间戳是否都是 YYYY/M/D HH:MM:SS 格式
4. 在不同浏览器/设备测试，确保格式一致
5. 监控多页签访问，确保 BroadcastChannel 同步正常

## 后续建议
1. 定期检查服务器日志，确保数据同步正常
2. 如果发现旧数据格式混乱，可运行数据清理脚本统一格式
3. 考虑添加数据版本控制，以便将来更容易处理格式变更
